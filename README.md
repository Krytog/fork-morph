# Fork-morph

## Сборка
После клонирования репозитория нужно подтянуть сабмодули:
```git submodule update --init --recursive```

Далее:
* ```mkdir build```
* ```cd build```
* ```cmake .. -DBUILD_ONLY="s3"```
* ```make fork-morph```

После этого получаем в ```build/src``` готовый бинарь.

## Использование
```fork-morph <path-to-src-manifest> <path-to-src-blob> <path-to-dst-manifest> <path-to-dst-blob> <path-to-output-blob>```

Здесь:
* path-to-src-manifest -- путь к манифесту модифицируемого блоба
* path-to-src-blob -- путь к модифицируемому блобу
* path-to-dst-manifest -- путь к манифесту нужного блоба
* path-to-dst-blob -- путь к нужному блобу. Он может быть как обычным локальным путём (удобно для тестов), так и путём к объекту в S3. Для последнего путь нужно начинать с ```S3@```, например, ```S3@http://localhost:9090/bucket/object```
` path-to-output-blob -- путь, по которому нужно сохранить итоговый блоб

Формат манифестов используется как в ```fork-blob```. Для того, чтобы получить манифест файла ```big.blob```, нужно использовать ```fork-blob big.blob > name.manifest```. Про сборку ```fork-blob``` рассказывается в соответствующем репозитории.


## Тестирование

В ```tests``` есть тесты для основного функционала: диффа, плана морфа и самого морфа. Для end2end тестирования можно использовать любые два файла, посчитать для них манифесты через ```fork-blob``` и проверить, что output будет равен dst_blob.

Подробнее о том, как это сделать:

* Нужны два бинаря: ```fork-morph``` и ```fork-blob```. Будем предполагать, что они лежат в текущей директории.
* Пусть в этой директории лежат ещё два файла: ```src.blob``` и ```dst.blob```.
* Готовим манифесты: ```./fork-blob src.blob > src.manifest``` и ```./fork-blob dst.blob > dst.manifest```.
* Морфим: ```./fork-morph src.manifest src.blob dst.manifest dst.blob out.blob```
* Проверяем, что они одинаковы: ```diff dst.blob out.blob```

Можно протестировать и с ```S3```. Локально можно поднять ```minio```, соответствующий скрипт -- это ```minio.sh```. В этом случае dst_blob должен находится в ```S3```, а путь к нему в аргументе должен начинаться с ```S3@```.

## Как это работает?

Сначала сравниваются манифесты и находится их дифф с помощью алгоримта Майерса. После этого по этому диффу строится так называемый "план морфа", который показывает, откуда (из src или dst) нужно брать чанки и какие именно. План оптимизируется: последовательные чанки из одного источника запрашиваются как один большой чанк. Таким образом получается готовый блоб.
